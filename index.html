import React, { useState, useEffect } from 'react';
import { Settings, RefreshCw, AlertCircle, Package, BarChart3, TrendingUp, Info } from 'lucide-react';

// --- КОНФИГУРАЦИЯ ---

const SIZE_WEIGHTS = {
  'ONE SIZE': 0, 'OS': 0,
  'XXS': 10, 'XS': 20, 'S': 30, 'M': 40, 'L': 50, 
  'XL': 60, 'XXL': 70, '2XL': 70, '3XL': 80, '4XL': 90, '5XL': 100
};

// --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

const getTurnoverColor = (value) => {
  if (value === '>999') return 'bg-red-100 text-red-800';
  if (value === 0) return 'bg-gray-100 text-gray-500';
  if (value <= 30) return 'bg-green-100 text-green-800';
  if (value <= 60) return 'bg-green-50 text-green-900';
  if (value <= 90) return 'bg-yellow-100 text-yellow-800';
  return 'bg-red-50 text-red-900';
};

const getSizeWeight = (s) => {
  const cleanS = String(s).toUpperCase().trim();
  if (!isNaN(cleanS) && cleanS !== '') return Number(cleanS) + 1000;
  if (SIZE_WEIGHTS[cleanS]) return SIZE_WEIGHTS[cleanS];
  return 5000;
};

// --- ОСНОВНОЙ КОМПОНЕНТ ---

export default function App() {
  const [apiKey, setApiKey] = useState('');
  const [isSettingsOpen, setIsSettingsOpen] = useState(true);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [data, setData] = useState([]);
  const [dates, setDates] = useState([]);
  const [stats, setStats] = useState({ totalStock: 0, totalSales7Days: 0 });

  // Инициализация
  useEffect(() => {
    const savedKey = localStorage.getItem('wb_api_key');
    if (savedKey) {
      setApiKey(savedKey);
      setIsSettingsOpen(false);
    }
    // Сообщаем Telegram что приложение готово
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  }, []);

  const saveApiKey = () => {
    localStorage.setItem('wb_api_key', apiKey);
    setIsSettingsOpen(false);
  };

  // --- ЛОГИКА ЗАГРУЗКИ ---
  const fetchData = async (isDemo = false) => {
    setLoading(true);
    setError(null);
    setData([]);

    try {
      // 1. Генерация дат (7 дней)
      const HISTORY_DAYS = 7;
      const today = new Date();
      const dateKeys = [];
      const displayDates = [];

      for (let i = HISTORY_DAYS; i >= 1; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        dateKeys.push(`${yyyy}-${mm}-${dd}`);
        displayDates.push(`${dd}.${mm}`);
      }
      setDates(displayDates);

      // ДЕМО РЕЖИМ
      if (isDemo) {
        await new Promise(r => setTimeout(r, 800)); // Имитация задержки
        const demoData = [
          { article: 'DEMO-1001', size: 'S', barcode: '111', currentStock: 110, sales: [2,4,5,4,6,4,8], avg: 4.71, turnover: 23 },
          { article: 'DEMO-1001', size: 'M', barcode: '222', currentStock: 45, sales: [3,3,5,1,3,2,2], avg: 2.71, turnover: 17 },
          { article: 'DEMO-1001', size: 'L', barcode: '333', currentStock: 0, sales: [0,0,1,0,0,0,0], avg: 0.14, turnover: 0 },
          { article: 'DEMO-1005', size: '42', barcode: '444', currentStock: 200, sales: [0,0,0,0,0,0,0], avg: 0, turnover: '>999' },
          { article: 'DEMO-1005', size: '44', barcode: '555', currentStock: 15, sales: [10,12,15,8,9,11,14], avg: 11.2, turnover: 1 },
        ];
        setData(demoData);
        setStats({ totalStock: 370, totalSales7Days: 130 });
        setLoading(false);
        setIsSettingsOpen(false);
        return;
      }

      // РЕАЛЬНЫЙ ЗАПРОС
      if (!apiKey) throw new Error('Введите API ключ');

      const startDateApi = `${dateKeys[0]}T00:00:00`;
      const PROXY = 'https://corsproxy.io/?'; 
      
      // Формируем ссылки
      const urlStocks = `https://statistics-api.wildberries.ru/api/v1/supplier/stocks?dateFrom=2024-01-01`;
      const urlOrders = `https://statistics-api.wildberries.ru/api/v1/supplier/orders?dateFrom=${startDateApi}&flag=0`;
      
      // Кодируем для прокси
      const fullUrlStocks = `${PROXY}${encodeURIComponent(urlStocks)}`;
      const fullUrlOrders = `${PROXY}${encodeURIComponent(urlOrders)}`;

      const headers = { 'Authorization': apiKey };

      // Запросы параллельно
      const [stocksRes, ordersRes] = await Promise.all([
        fetch(fullUrlStocks, { headers }),
        fetch(fullUrlOrders, { headers })
      ]);

      if (stocksRes.status === 401 || ordersRes.status === 401) {
        throw new Error('Ошибка 401: Неверный API ключ (проверьте, что это ключ "Статистика")');
      }
      if (!stocksRes.ok) throw new Error(`Ошибка Stocks: ${stocksRes.status}`);
      if (!ordersRes.ok) throw new Error(`Ошибка Orders: ${ordersRes.status}`);

      const stocksJson = await stocksRes.json();
      const ordersJson = await ordersRes.json();

      // Обработка данных
      const stocksMap = new Map();
      stocksJson.forEach(item => {
        const barcode = String(item.barcode);
        if (stocksMap.has(barcode)) {
          stocksMap.get(barcode).quantity += (item.quantity || 0);
        } else {
          stocksMap.set(barcode, {
            article: item.supplierArticle || item.name || '---',
            size: item.techSize || '',
            quantity: item.quantity || 0
          });
        }
      });

      const ordersMap = new Map();
      const productsInfoMap = new Map();
      const todayStr = new Date().toISOString().split('T')[0];

      ordersJson.forEach(order => {
        if (!order.date) return;
        const orderDate = order.date.split('T')[0];
        if (orderDate === todayStr) return; // Игнорируем сегодня
        if (order.cancel_dt && order.cancel_dt <= orderDate) return;

        const barcode = String(order.barcode);

        if (!ordersMap.has(barcode)) ordersMap.set(barcode, new Map());
        const dMap = ordersMap.get(barcode);
        dMap.set(orderDate, (dMap.get(orderDate) || 0) + 1);

        if (!stocksMap.has(barcode) && !productsInfoMap.has(barcode)) {
          productsInfoMap.set(barcode, {
            article: order.supplierArticle || 'Заказ',
            size: order.techSize || '',
            quantity: 0
          });
        }
      });

      // Сборка таблицы
      const allBarcodes = new Set([...stocksMap.keys(), ...productsInfoMap.keys()]);
      let tableData = [];
      let totalStockCalc = 0;
      let totalSalesCalc = 0;

      allBarcodes.forEach(barcode => {
        const stockInfo = stocksMap.get(barcode);
        const orderInfo = productsInfoMap.get(barcode);

        const article = stockInfo?.article || orderInfo?.article || 'Неизвестно';
        const size = stockInfo?.size || orderInfo?.size || '';
        const currentStock = stockInfo?.quantity || 0;

        totalStockCalc += currentStock;

        const salesArr = [];
        let sumSales = 0;

        dateKeys.forEach(dateKey => {
          const count = ordersMap.get(barcode)?.get(dateKey) || 0;
          salesArr.push(count);
          sumSales += count;
        });

        totalSalesCalc += sumSales;

        const avg = sumSales / HISTORY_DAYS;
        let turnover = 0;
        if (avg > 0) {
          turnover = Math.round(currentStock / avg);
        } else if (currentStock > 0) {
          turnover = '>999';
        }

        tableData.push({
          barcode,
          article,
          size,
          currentStock,
          sales: salesArr,
          avg: Number(avg.toFixed(2)),
          turnover
        });
      });

      // Сортировка
      tableData.sort((a, b) => {
        if (a.article < b.article) return -1;
        if (a.article > b.article) return 1;
        
        const wA = getSizeWeight(a.size);
        const wB = getSizeWeight(b.size);
        if (wA !== wB) return wA - wB;
        return a.size.localeCompare(b.size);
      });

      setData(tableData);
      setStats({ totalStock: totalStockCalc, totalSales7Days: totalSalesCalc });

    } catch (err) {
      console.error(err);
      setError(err.message + '. Попробуйте включить VPN.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 text-sm font-sans pb-10">
      
      {/* HEADER */}
      <div className="bg-[#4a148c] text-white p-4 sticky top-0 z-20 shadow-lg">
        <div className="flex justify-between items-center mb-2">
          <h1 className="text-lg font-bold flex items-center gap-2">
            <BarChart3 size={20} />
            WB Analytics
          </h1>
          <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className="p-2 hover:bg-white/10 rounded-full">
            <Settings size={20} />
          </button>
        </div>
        
        {!isSettingsOpen && data.length > 0 && (
          <div className="flex gap-4 text-xs opacity-90">
            <div className="flex items-center gap-1">
              <Package size={14} /> Остаток: <span className="font-bold">{stats.totalStock}</span>
            </div>
            <div className="flex items-center gap-1">
              <TrendingUp size={14} /> Продажи (7д): <span className="font-bold">{stats.totalSales7Days}</span>
            </div>
          </div>
        )}
      </div>

      {/* SETTINGS */}
      {isSettingsOpen && (
        <div className="p-4 bg-white border-b border-gray-200 animate-in slide-in-from-top-2">
          <label className="block text-xs font-bold text-gray-700 mb-2">API Ключ (Статистика)</label>
          <input
            type="text"
            value={apiKey}
            onChange={(e) => setApiKey(e.target.value)}
            placeholder="Вставьте токен WB..."
            className="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:border-[#4a148c] text-xs"
          />
          <div className="flex gap-2">
            <button 
              onClick={() => { saveApiKey(); fetchData(false); }}
              disabled={!apiKey && !loading}
              className="flex-1 bg-[#4a148c] text-white py-3 rounded-lg font-bold shadow active:scale-95 transition-transform disabled:opacity-50"
            >
              Загрузить данные
            </button>
            <button 
              onClick={() => fetchData(true)}
              className="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold shadow active:scale-95 transition-transform"
            >
              Демо
            </button>
          </div>
        </div>
      )}

      {/* ERROR */}
      {error && (
        <div className="m-4 p-3 bg-red-50 text-red-700 rounded-lg border border-red-200 flex gap-2 items-center text-xs">
          <AlertCircle size={16} className="shrink-0" />
          <span>{error}</span>
        </div>
      )}

      {/* LOADING */}
      {loading && (
        <div className="flex flex-col items-center justify-center py-20 text-[#4a148c]">
          <RefreshCw className="animate-spin mb-2" size={32} />
          <span className="text-xs font-medium">Загрузка...</span>
        </div>
      )}

      {/* TABLE */}
      {!loading && data.length > 0 && (
        <div className="overflow-x-auto">
          <table className="w-full border-collapse bg-white shadow-sm">
            <thead className="bg-gray-100 text-gray-600 text-[10px] uppercase tracking-wider sticky top-[72px] shadow-sm z-10">
              <tr>
                <th className="p-2 text-left w-8">№</th>
                <th className="p-2 text-left min-w-[80px]">Артикул</th>
                <th className="p-2 text-center w-10">Р-р</th>
                {dates.map((d, i) => (
                  <th key={i} className="p-2 text-center min-w-[30px] font-normal text-gray-400">{d}</th>
                ))}
                <th className="p-2 text-center min-w-[40px] font-bold text-gray-800 bg-gray-50 border-l">Ост.</th>
                <th className="p-2 text-center min-w-[35px] border-l">Ср.</th>
                <th className="p-2 text-center min-w-[35px] border-l">Об.</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {data.map((row, index) => (
                <tr key={`${row.barcode}-${index}`} className="hover:bg-purple-50 transition-colors">
                  <td className="p-2 text-gray-400 text-[10px]">{index + 1}</td>
                  <td className="p-2 font-medium text-gray-800">
                    <div className="flex flex-col">
                      <span>{row.article}</span>
                      <span className="text-[9px] text-gray-400 font-normal">{row.barcode}</span>
                    </div>
                  </td>
                  <td className="p-2 text-center">
                    <span className="inline-block px-1.5 py-0.5 rounded bg-gray-100 text-[10px] font-medium text-gray-600">
                      {row.size}
                    </span>
                  </td>
                  
                  {row.sales.map((s, i) => (
                    <td key={i} className={`p-2 text-center text-xs ${s > 0 ? 'font-bold text-[#4a148c]' : 'text-gray-200'}`}>
                      {s > 0 ? s : '·'}
                    </td>
                  ))}
                  
                  <td className="p-2 text-center font-bold text-gray-900 border-l border-gray-100 bg-gray-50/50">
                    {row.currentStock}
                  </td>
                  <td className="p-2 text-center text-xs text-gray-600 border-l border-gray-100">
                    {row.avg}
                  </td>
                  <td className="p-2 text-center border-l border-gray-100">
                    <div className={`text-[10px] font-bold px-1 py-0.5 rounded ${getTurnoverColor(row.turnover)}`}>
                       {row.turnover}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* EMPTY STATE */}
      {!loading && data.length === 0 && !isSettingsOpen && (
        <div className="flex flex-col items-center justify-center py-20 text-gray-400">
          <Info size={40} className="mb-2 opacity-50" />
          <p>Нет данных</p>
          <button onClick={() => setIsSettingsOpen(true)} className="mt-4 text-[#4a148c] font-medium">
            Открыть настройки
          </button>
        </div>
      )}

      <div className="fixed bottom-0 w-full bg-white border-t p-2 text-center text-[10px] text-gray-400 z-20">
        Сортировка: Артикул → Размер. Данные за 7 дней.
      </div>
    </div>
  );
}
