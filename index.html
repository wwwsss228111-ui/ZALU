import React, { useState, useEffect, useMemo } from 'react';
import { Settings, RefreshCw, AlertCircle, ArrowUp, Info, Package, BarChart3, TrendingUp } from 'lucide-react';

// --- КОНФИГУРАЦИЯ И УТИЛИТЫ ---

const SIZE_WEIGHTS = {
  'ONE SIZE': 0, 'OS': 0,
  'XXS': 10, 'XS': 20, 'S': 30, 'M': 40, 'L': 50, 
  'XL': 60, 'XXL': 70, '2XL': 70, '3XL': 80, '4XL': 90, '5XL': 100
};

// Функция определения цвета оборачиваемости (Градиент)
const getTurnoverColor = (value) => {
  if (value === '>999') return 'bg-red-100 text-red-800';
  if (value === 0) return 'bg-gray-100 text-gray-500';
  
  // Условный градиент: < 30 дней (зеленый), 30-90 (желтый), > 90 (красный)
  if (value <= 30) return 'bg-green-100 text-green-800';
  if (value <= 60) return 'bg-green-50 text-green-900'; // Светло-зеленый
  if (value <= 90) return 'bg-yellow-100 text-yellow-800';
  return 'bg-red-50 text-red-900';
};

// Вес размера для сортировки
const getSizeWeight = (s) => {
  const cleanS = String(s).toUpperCase().trim();
  if (!isNaN(cleanS) && cleanS !== '') return Number(cleanS) + 1000;
  if (SIZE_WEIGHTS[cleanS]) return SIZE_WEIGHTS[cleanS];
  return 5000;
};

export default function App() {
  const [apiKey, setApiKey] = useState('');
  const [isSettingsOpen, setIsSettingsOpen] = useState(true); // Открыто по умолчанию, если нет ключа
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [data, setData] = useState([]);
  const [dates, setDates] = useState([]);
  const [stats, setStats] = useState({ totalStock: 0, totalSales7Days: 0 });

  // Загрузка ключа из памяти при старте
  useEffect(() => {
    const savedKey = localStorage.getItem('wb_api_key');
    if (savedKey) {
      setApiKey(savedKey);
      setIsSettingsOpen(false);
    }
    
    // Инициализация Telegram WebApp
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      // Устанавливаем цвета под тему телеграм, но у нас свой фиолетовый стиль
    }
  }, []);

  const saveApiKey = () => {
    localStorage.setItem('wb_api_key', apiKey);
    setIsSettingsOpen(false);
  };

  // --- ЛОГИКА ЗАГРУЗКИ (АНАЛОГ GOOGLE SCRIPT) ---
  const fetchData = async () => {
    setLoading(true);
    setError(null);

    try {
      // 1. Генерация дат (последние 7 дней)
      const HISTORY_DAYS = 7;
      const today = new Date();
      const dateKeys = [];
      const displayDates = [];

      for (let i = HISTORY_DAYS; i >= 1; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        
        dateKeys.push(`${yyyy}-${mm}-${dd}`);
        displayDates.push(`${dd}.${mm}`);
      }
      setDates(displayDates);

      const startDateApi = `${dateKeys[0]}T00:00:00`;

      // 2. Запросы к API (через corsproxy.io для обхода CORS в браузере, если нужно)
      const headers = { 'Authorization': apiKey };
      
      // ВНИМАНИЕ: Используем публичный CORS прокси.
      // encodeURIComponent обязателен, чтобы параметры WB API не терялись при передаче через прокси
      const PROXY = 'https://corsproxy.io/?'; 
      const STOCKS_URL = `${PROXY}${encodeURIComponent(`https://statistics-api.wildberries.ru/api/v1/supplier/stocks?dateFrom=2024-01-01`)}`;
      const ORDERS_URL = `${PROXY}${encodeURIComponent(`https://statistics-api.wildberries.ru/api/v1/supplier/orders?dateFrom=${startDateApi}&flag=0`)}`;

      // А) Остатки
      const stocksRes = await fetch(STOCKS_URL, { headers });
      if (!stocksRes.ok) throw new Error('Ошибка загрузки остатков. Проверьте ключ.');
      const stocksJson = await stocksRes.json();

      // Б) Заказы
      const ordersRes = await fetch(ORDERS_URL, { headers });
      if (!ordersRes.ok) throw new Error('Ошибка загрузки заказов.');
      const ordersJson = await ordersRes.json();

      // 3. Обработка данных
      const stocksMap = new Map();
      stocksJson.forEach(item => {
        const barcode = String(item.barcode);
        if (stocksMap.has(barcode)) {
          stocksMap.get(barcode).quantity += (item.quantity || 0);
        } else {
          stocksMap.set(barcode, {
            article: item.supplierArticle || item.name || 'Нет названия',
            size: item.techSize || '',
            quantity: item.quantity || 0
          });
        }
      });

      const ordersMap = new Map(); // Barcode -> Map<Date, Count>
      const productsInfoMap = new Map();
      const todayStr = new Date().toISOString().split('T')[0];

      ordersJson.forEach(order => {
        if (!order.date) return;
        const orderDate = order.date.split('T')[0];
        if (orderDate === todayStr) return; // Игнорируем сегодня
        if (order.cancel_dt && order.cancel_dt <= orderDate) return;

        const barcode = String(order.barcode);

        if (!ordersMap.has(barcode)) ordersMap.set(barcode, new Map());
        const dMap = ordersMap.get(barcode);
        dMap.set(orderDate, (dMap.get(orderDate) || 0) + 1);

        if (!stocksMap.has(barcode) && !productsInfoMap.has(barcode)) {
          productsInfoMap.set(barcode, {
            article: order.supplierArticle || 'Из заказов',
            size: order.techSize || '',
            quantity: 0
          });
        }
      });

      // 4. Сборка таблицы
      const allBarcodes = new Set([...stocksMap.keys(), ...productsInfoMap.keys()]);
      let tableData = [];
      let totalStockCalc = 0;
      let totalSalesCalc = 0;

      allBarcodes.forEach(barcode => {
        const stockInfo = stocksMap.get(barcode);
        const orderInfo = productsInfoMap.get(barcode);

        const article = stockInfo?.article || orderInfo?.article || 'Неизвестно';
        const size = stockInfo?.size || orderInfo?.size || '';
        const currentStock = stockInfo?.quantity || 0;

        totalStockCalc += currentStock;

        const salesArr = [];
        let sumSales = 0;

        dateKeys.forEach(dateKey => {
          const count = ordersMap.get(barcode)?.get(dateKey) || 0;
          salesArr.push(count);
          sumSales += count;
        });

        totalSalesCalc += sumSales;

        const avg = sumSales / HISTORY_DAYS;
        let turnover = 0;
        if (avg > 0) {
          turnover = Math.round(currentStock / avg);
        } else if (currentStock > 0) {
          turnover = '>999';
        }

        tableData.push({
          barcode,
          article,
          size,
          currentStock,
          sales: salesArr,
          avg: Number(avg.toFixed(2)),
          turnover
        });
      });

      // 5. Сортировка
      tableData.sort((a, b) => {
        if (a.article < b.article) return -1;
        if (a.article > b.article) return 1;
        
        const wA = getSizeWeight(a.size);
        const wB = getSizeWeight(b.size);
        if (wA !== wB) return wA - wB;
        return a.size.localeCompare(b.size);
      });

      setData(tableData);
      setStats({ totalStock: totalStockCalc, totalSales7Days: totalSalesCalc });

    } catch (err) {
      console.error(err);
      setError(err.message + '. Попробуйте включить VPN.');
    } finally {
      setLoading(false);
    }
  };

  // Демо данные для показа интерфейса
  const loadDemoData = () => {
    setLoading(true);
    setTimeout(() => {
      const demoData = [
        { article: '1001', size: 'S', barcode: '111', currentStock: 110, sales: [2,4,5,4,6,4,8], avg: 4.71, turnover: 23 },
        { article: '1001', size: 'M', barcode: '222', currentStock: 45, sales: [3,3,5,1,3,2,2], avg: 2.71, turnover: 17 },
        { article: '1001', size: 'L', barcode: '333', currentStock: 0, sales: [0,0,1,0,0,0,0], avg: 0.14, turnover: 0 },
        { article: '1005', size: '42', barcode: '444', currentStock: 200, sales: [0,0,0,0,0,0,0], avg: 0, turnover: '>999' },
        { article: '1005', size: '44', barcode: '555', currentStock: 15, sales: [10,12,15,8,9,11,14], avg: 11.2, turnover: 1 },
      ];
      // Генерация дат
      const today = new Date();
      const displayDates = [];
      for (let i = 7; i >= 1; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        displayDates.push(`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`);
      }
      setDates(displayDates);
      setData(demoData);
      setStats({ totalStock: 370, totalSales7Days: 130 });
      setLoading(false);
      setIsSettingsOpen(false);
    }, 1000);
  };

  return (
    <div className="min-h-screen bg-gray-50 text-sm font-sans pb-10">
      
      {/* HEADER */}
      <div className="bg-[#4a148c] text-white p-4 sticky top-0 z-20 shadow-lg">
        <div className="flex justify-between items-center mb-2">
          <h1 className="text-lg font-bold flex items-center gap-2">
            <BarChart3 size={20} />
            WB Analytics
          </h1>
          <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className="p-2 hover:bg-white/10 rounded-full">
            <Settings size={20} />
          </button>
        </div>
        
        {/* Мини-сводка */}
        {!isSettingsOpen && data.length > 0 && (
          <div className="flex gap-4 text-xs opacity-90">
            <div className="flex items-center gap-1">
              <Package size={14} /> Остаток: <span className="font-bold">{stats.totalStock}</span>
            </div>
            <div className="flex items-center gap-1">
              <TrendingUp size={14} /> Продажи (7д): <span className="font-bold">{stats.totalSales7Days}</span>
            </div>
          </div>
        )}
      </div>

      {/* SETTINGS / API INPUT */}
      {isSettingsOpen && (
        <div className="p-4 bg-white border-b border-gray-200 animate-in slide-in-from-top-2">
          <label className="block text-xs font-bold text-gray-700 mb-2">API Ключ (Статистика)</label>
          <input
            type="text"
            value={apiKey}
            onChange={(e) => setApiKey(e.target.value)}
            placeholder="Вставьте токен WB..."
            className="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:border-[#4a148c] text-xs"
          />
          <div className="flex gap-2">
            <button 
              onClick={() => { saveApiKey(); fetchData(); }}
              disabled={!apiKey}
              className="flex-1 bg-[#4a148c] text-white py-3 rounded-lg font-bold shadow active:scale-95 transition-transform disabled:opacity-50"
            >
              Загрузить данные
            </button>
            <button 
              onClick={loadDemoData}
              className="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold shadow active:scale-95 transition-transform"
            >
              Демо
            </button>
          </div>
          <div className="mt-2 flex items-start gap-2 text-gray-500 text-[10px]">
             <AlertCircle size={12} className="mt-0.5" />
             <p>Прямые запросы из Telegram могут блокироваться WB. Если данные не грузятся, нужен backend-прокси.</p>
          </div>
        </div>
      )}

      {/* ERROR MESSAGE */}
      {error && (
        <div className="m-4 p-3 bg-red-50 text-red-700 rounded-lg border border-red-200 flex gap-2 items-center text-xs">
          <AlertCircle size={16} />
          {error}
        </div>
      )}

      {/* LOADING STATE */}
      {loading && (
        <div className="flex flex-col items-center justify-center py-20 text-[#4a148c]">
          <RefreshCw className="animate-spin mb-2" size={32} />
          <span className="text-xs font-medium">Загружаем данные WB...</span>
        </div>
      )}

      {/* DATA TABLE */}
      {!loading && data.length > 0 && (
        <div className="overflow-x-auto">
          <table className="w-full border-collapse bg-white shadow-sm">
            <thead className="bg-gray-100 text-gray-600 text-[10px] uppercase tracking-wider sticky top-[72px] shadow-sm z-10">
              <tr>
                <th className="p-2 text-left w-8">№</th>
                <th className="p-2 text-left min-w-[80px]">Артикул</th>
                <th className="p-2 text-center w-10">Р-р</th>
                {dates.map((d, i) => (
                  <th key={i} className="p-2 text-center min-w-[30px] font-normal text-gray-400">{d}</th>
                ))}
                <th className="p-2 text-center min-w-[50px] font-bold text-gray-800 bg-gray-50 border-l">Ост.</th>
                <th className="p-2 text-center min-w-[40px] border-l">Ср.</th>
                <th className="p-2 text-center min-w-[40px] border-l">Об.</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {data.map((row, index) => (
                <tr key={row.barcode} className="hover:bg-purple-50 transition-colors">
                  <td className="p-2 text-gray-400 text-[10px]">{index + 1}</td>
                  <td className="p-2 font-medium text-gray-800">
                    <div className="flex flex-col">
                      <span>{row.article}</span>
                      <span className="text-[9px] text-gray-400 font-normal">{row.barcode}</span>
                    </div>
                  </td>
                  <td className="p-2 text-center">
                    <span className="inline-block px-1.5 py-0.5 rounded bg-gray-100 text-[10px] font-medium text-gray-600">
                      {row.size}
                    </span>
                  </td>
                  
                  {/* Продажи по дням */}
                  {row.sales.map((s, i) => (
                    <td key={i} className={`p-2 text-center text-xs ${s > 0 ? 'font-bold text-[#4a148c]' : 'text-gray-200'}`}>
                      {s > 0 ? s : '·'}
                    </td>
                  ))}
                  
                  {/* Остаток */}
                  <td className="p-2 text-center font-bold text-gray-900 border-l border-gray-100 bg-gray-50/50">
                    {row.currentStock}
                  </td>
                  
                  {/* Среднее */}
                  <td className="p-2 text-center text-xs text-gray-600 border-l border-gray-100">
                    {row.avg}
                  </td>
                  
                  {/* Оборачиваемость (ЦВЕТНАЯ) */}
                  <td className="p-2 text-center border-l border-gray-100">
                    <div className={`text-[10px] font-bold px-1 py-0.5 rounded ${getTurnoverColor(row.turnover)}`}>
                       {row.turnover}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {!loading && data.length === 0 && !isSettingsOpen && (
        <div className="flex flex-col items-center justify-center py-20 text-gray-400">
          <Info size={40} className="mb-2 opacity-50" />
          <p>Нет данных для отображения</p>
          <button onClick={() => setIsSettingsOpen(true)} className="mt-4 text-[#4a148c] font-medium">
            Настроить API
          </button>
        </div>
      )}
      
      {/* Footer hint */}
      <div className="fixed bottom-0 w-full bg-white border-t p-2 text-center text-[10px] text-gray-400 z-20">
        Сортировка: Артикул &rarr; Размер. Данные за 7 дней.
      </div>

    </div>
  );
}
