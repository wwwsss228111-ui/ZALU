import React, { useState, useEffect } from 'react';
import { Settings, Activity, Server, ShieldAlert, CheckCircle, Terminal } from 'lucide-react';

export default function App() {
  const [apiKey, setApiKey] = useState('');
  const [logs, setLogs] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [responsePreview, setResponsePreview] = useState(null);

  // Загрузка ключа при старте
  useEffect(() => {
    const savedKey = localStorage.getItem('wb_api_key');
    if (savedKey) setApiKey(savedKey);
  }, []);

  const addLog = (msg, type = 'info') => {
    const timestamp = new Date().toLocaleTimeString();
    setLogs(prev => [...prev, { time: timestamp, msg, type }]);
  };

  const runDiagnostics = async () => {
    setIsLoading(true);
    setLogs([]); // Очистить логи
    setResponsePreview(null);

    addLog('Начинаем тест соединения...', 'info');

    if (!apiKey) {
      addLog('ОШИБКА: Нет API ключа.', 'error');
      setIsLoading(false);
      return;
    }

    // Сохраняем ключ
    localStorage.setItem('wb_api_key', apiKey);

    // 1. Формируем URL
    // Берем дату "вчера", чтобы данных было немного
    const dateFrom = new Date();
    dateFrom.setDate(dateFrom.getDate() - 10);
    const dateStr = dateFrom.toISOString().split('T')[0];

    // Используем corsproxy.io
    const PROXY = 'https://corsproxy.io/?';
    // Пробуем самый простой метод - stocks (остатки)
    const TARGET_URL = `https://statistics-api.wildberries.ru/api/v1/supplier/stocks?dateFrom=${dateStr}`;
    
    // ВАЖНО: Кодируем целевой URL, чтобы спецсимволы не ломали прокси
    const FULL_URL = `${PROXY}${encodeURIComponent(TARGET_URL)}`;

    addLog(`Прокси: ${PROXY}`, 'info');
    addLog(`Цель: ${TARGET_URL}`, 'info');

    try {
      addLog('Отправка запроса fetch()...', 'info');
      
      const response = await fetch(FULL_URL, {
        method: 'GET',
        headers: {
          'Authorization': apiKey,
          // Иногда прокси требуют явных заголовков, но corsproxy обычно прост
        }
      });

      addLog(`Статус ответа HTTP: ${response.status}`, response.ok ? 'success' : 'error');

      if (response.status === 401) {
        addLog('ОШИБКА 401: Неверный API ключ. Проверьте, что вы взяли именно токен "Статистика".', 'error');
        setIsLoading(false);
        return;
      }
      
      if (response.status === 429) {
        addLog('ОШИБКА 429: Слишком много запросов. WB заблокировал нас на минуту.', 'error');
        setIsLoading(false);
        return;
      }

      const text = await response.text();
      addLog(`Получено байт: ${text.length}`, 'info');

      if (!response.ok) {
        addLog(`Тело ошибки: ${text.slice(0, 100)}...`, 'error');
        throw new Error(`HTTP Error ${response.status}`);
      }

      // Пытаемся распарсить JSON
      try {
        const json = JSON.parse(text);
        addLog(`JSON успешно распаршен! Элементов: ${json.length}`, 'success');
        
        if (json.length > 0) {
          setResponsePreview(JSON.stringify(json.slice(0, 2), null, 2)); // Показать первые 2 элемента
          addLog('Данные получены корректно.', 'success');
        } else {
          addLog('JSON пустой ( [] ). Возможно, нет остатков на эту дату?', 'warning');
        }

      } catch (e) {
        addLog('ОШИБКА JSON: Ответ не является валидным JSON.', 'error');
        addLog(`Начало ответа: ${text.slice(0, 50)}...`, 'info');
      }

    } catch (err) {
      addLog(`Сетевая ошибка: ${err.message}`, 'error');
      addLog('Совет: Попробуйте включить VPN или открыть эту страницу не в Telegram, а в браузере (Chrome/Safari).', 'warning');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 p-4 font-mono text-sm">
      <div className="max-w-md mx-auto">
        
        <h1 className="text-xl font-bold mb-4 flex items-center gap-2 text-purple-400">
          <Activity /> WB API Диагностика
        </h1>

        <div className="bg-gray-800 p-4 rounded-lg mb-4 border border-gray-700">
          <label className="block text-xs text-gray-400 mb-1">API Токен (Статистика)</label>
          <input 
            type="text" 
            value={apiKey}
            onChange={e => setApiKey(e.target.value)}
            className="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-purple-500 outline-none"
            placeholder="eyJhbGciOi..."
          />
          <button 
            onClick={runDiagnostics}
            disabled={isLoading}
            className={`mt-3 w-full py-2 rounded font-bold flex items-center justify-center gap-2 ${isLoading ? 'bg-gray-600' : 'bg-purple-600 hover:bg-purple-500'}`}
          >
            {isLoading ? <RefreshCwSpin /> : <Server size={16} />}
            {isLoading ? 'Проверка...' : 'Проверить связь'}
          </button>
        </div>

        {/* LOGS CONSOLE */}
        <div className="bg-black rounded-lg p-3 border border-gray-700 min-h-[200px] font-mono text-xs overflow-hidden">
          <div className="flex items-center gap-2 text-gray-500 mb-2 border-b border-gray-800 pb-1">
            <Terminal size={12} />
            <span>Console Log</span>
          </div>
          
          <div className="flex flex-col gap-1">
            {logs.length === 0 && <span className="text-gray-600 italic">Ожидание запуска...</span>}
            
            {logs.map((log, idx) => (
              <div key={idx} className={`flex gap-2 ${getColor(log.type)}`}>
                <span className="text-gray-600">[{log.time}]</span>
                <span>{log.msg}</span>
              </div>
            ))}
          </div>
        </div>

        {/* PREVIEW */}
        {responsePreview && (
          <div className="mt-4">
            <h3 className="text-green-400 font-bold mb-1 flex items-center gap-2">
              <CheckCircle size={16} /> Успешный ответ (пример):
            </h3>
            <pre className="bg-gray-800 p-3 rounded text-[10px] overflow-x-auto border border-green-900/30 text-green-100">
              {responsePreview}
            </pre>
            <p className="mt-2 text-gray-400 text-xs">
              Если вы видите данные выше, значит связь работает, и можно возвращать основной интерфейс.
            </p>
          </div>
        )}

      </div>
    </div>
  );
}

// --- Helpers ---

const RefreshCwSpin = () => (
  <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>
);

const getColor = (type) => {
  switch (type) {
    case 'error': return 'text-red-400 font-bold';
    case 'success': return 'text-green-400';
    case 'warning': return 'text-yellow-400';
    default: return 'text-gray-300';
  }
};
